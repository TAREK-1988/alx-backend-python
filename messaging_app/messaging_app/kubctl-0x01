#!/usr/bin/env bash
set -euo pipefail

NAMESPACE="${KUBE_NAMESPACE:-default}"
DEPLOYMENT_NAME="messaging-app"
SERVICE_NAME="messaging-app-service"

echo "Scaling deployment ${DEPLOYMENT_NAME} to 3 replicas..."
kubectl scale deployment "${DEPLOYMENT_NAME}" --replicas=3 --namespace "${NAMESPACE}"

echo "Current pods:"
kubectl get pods -l app=messaging-app --namespace "${NAMESPACE}"

echo "Starting port-forward on :8000..."
kubectl port-forward service/"${SERVICE_NAME}" 8000:8000 --namespace "${NAMESPACE}" >/dev/null 2>&1 &
PF_PID=$!
sleep 5

if command -v wrk >/dev/null 2>&1; then
  echo "Running wrk load test against http://127.0.0.1:8000/ ..."
  wrk -t2 -c50 -d30s http://127.0.0.1:8000/ || true
else
  echo "wrk is not installed. Skipping load test." >&2
fi

echo "Stopping port-forward..."
kill "${PF_PID}" >/dev/null 2>&1 || true

echo "Resource usage (if metrics-server is installed):"
if kubectl top pods --namespace "${NAMESPACE}" >/dev/null 2>&1; then
  kubectl top pods --namespace "${NAMESPACE}"
else
  echo "kubectl top not available (metrics-server missing)." >&2
fi
